(function(){var bitcoinApp,getFieldValidationExpression,hashrateFilter;bitcoinApp=angular.module("bitcoinApp",["ngRoute","ngCookies","ngResource","ngSanitize","ui.validate","ui.bootstrap","interval"]).config(function($routeProvider,$httpProvider){var anonymous,interceptor,requireAuthentication;return requireAuthentication=function(original){var resolver;return null==original&&(original={}),resolver={},_.extend(resolver,original,{__authentication:function($q,authentication){var deferred;return authentication.isAuthenticated()?(deferred=$q.defer(),deferred.resolve(),deferred.promise):$q.reject("/login")}}),resolver},anonymous=function(original){return null==original&&(original={}),original},interceptor=function($location,$q){var error,success;return success=function(response){return response},error=function(response){return 401===response.status?(console.log("oops, session appears to be expired"),$location.path("/login"),$q.reject(response)):$q.reject(response)},function(promise){return promise.then(success,error)}},$httpProvider.responseInterceptors.push(interceptor),$routeProvider.when("/dashboard",{templateUrl:"/templates/dashboard.html",controller:"DashboardCtrl",title:"Dashboard",resolve:requireAuthentication()}),$routeProvider.when("/pools",{templateUrl:"/templates/pools.html",controller:"PoolsCtrl",title:"Pools",resolve:requireAuthentication()}),$routeProvider.when("/pools/:poolId",{templateUrl:"/templates/poolEdit.html",controller:"PoolEditCtrl",title:"Edit Pool",resolve:requireAuthentication()}),$routeProvider.when("/wallet",{templateUrl:"/templates/wallet.html",controller:"WalletCtrl",title:"Wallet",resolve:requireAuthentication()}),$routeProvider.when("/wallet/send",{templateUrl:"/templates/send.html",controller:"SendCtrl",title:"Send Bitcoins",resolve:requireAuthentication()}),$routeProvider.when("/wallet/sign",{templateUrl:"/templates/sign.html",controller:"SignCtrl",title:"Sign Message",resolve:requireAuthentication()}),$routeProvider.when("/wallet/addresses",{templateUrl:"/templates/addressList.html",controller:"AddressListCtrl",title:"Addresses",resolve:requireAuthentication()}),$routeProvider.when("/login",{templateUrl:"/templates/login.html",controller:"LoginCtrl",title:"Login",resolve:anonymous()}),$routeProvider.otherwise({redirectTo:"/dashboard"})}).run(function($rootScope,$location){$rootScope.$on("$routeChangeError",function(event,current,previous,rejection){"/login"===rejection&&$location.path("/login")}),$rootScope.$on("$routeChangeSuccess",function(event,current){var _ref;$rootScope.pageTitle=null!=current?null!=(_ref=current.$$route)?_ref.title:void 0:void 0})}),bitcoinApp.controller("AddressListCtrl",function($scope,walletInfo,popups){$scope.loading=!0,$scope.addresses=walletInfo.getAddresses(),$scope.addresses.$promise.then(function(){return $scope.loading=!1}),$scope.showArchived=!1,$scope.toggleArchived=function(item){item.archived=!item.archived,item.$save()},$scope.rename=function(item){popups.changeLabel(item.address,item.label).open().then(function(result){(null!=result?result.result:void 0)&&(item.label=result.label,item.$save())})},$scope.qr=function(item){popups.showAddress(item.address,item.label).open()}}),bitcoinApp.controller("ChangeLabelCtrl",function($scope,dialog,model){return $scope.title=model.title,$scope.address=model.address,$scope.initial=model.label,$scope.buttons=model.buttons,$scope.cancel=function(){return dialog.close({result:!1})},$scope.save=function(){return dialog.close({result:!0,label:$scope.label})}}),bitcoinApp.controller("DashboardCtrl",function($scope,$timeout,miningStats,walletInfo,authentication,socket,safeIdFilter){var chartConfig,miningTimeout,oncePerMinute,oncePerTenSeconds,sixtySeconds,tenSeconds,updateChart,updateMiningSummary,updatePrice,updateWallet,walletTimeout;return $scope.authenticated=authentication.isAuthenticated(),$scope.mining=miningStats.getSummary(),$scope.wallet=walletInfo.getSummary(5),$scope.price=walletInfo.getPrice(),updateMiningSummary=function(){return $scope.mining.$get()},updatePrice=function(){return $scope.price.$get()},updateWallet=function(){return $scope.wallet.$get({show:5})},Highcharts.setOptions({global:{useUTC:!1}}),chartConfig={chart:{backgroundColor:"#f6f6f6",type:"area",animation:!0},credits:{enabled:!1},colors:["#4572a7","#aa4643","#80699b","#3d96ae","#db843d"],plotOptions:{area:{fillOpacity:.5,lineWidth:1},series:{animation:!1,marker:{enabled:!1},stacking:"normal"}},xAxis:{type:"datetime",tickInterval:864e5,gridLineWidth:1,endOnTick:!1},yAxis:{min:0,showFirstLabel:!1,endOnTick:!1,title:{text:null},labels:{formatter:function(){return hashrateFilter(this.value)}}},loading:!0,title:{text:"Hash Rate, Past 3 Days"}},updateChart=function(){return miningStats.getChart().$promise.then(function(chartData){var _ref;chartConfig.plotOptions.series.pointInterval=chartData.pointInterval,chartConfig.plotOptions.series.pointStart=chartData.pointStart,chartConfig.series=chartData.series,chartConfig.loading=!1,null!=(_ref=$("#chart").highcharts())&&_ref.destroy(),$("#chart").highcharts(chartConfig)})},updateChart(),socket.on("share",function(data){var device,deviceId,id,pool,poolId,_i,_len,_ref;if(null!=$scope.mining.devices){for(poolId="#pool-"+safeIdFilter(data.pool),deviceId="#device-"+safeIdFilter(data.hostname+":"+data.device),_ref=[poolId,deviceId],_i=0,_len=_ref.length;_len>_i;_i++)id=_ref[_i],$(id).stop().clearQueue().fadeTo(0,1).fadeTo(700,0);return device=_.find($scope.mining.devices[data.hostname],function(d){return d.device===data.device}),pool=_.find($scope.mining.pools,function(p){return p.name===data.pool}),null!=device&&null!=pool?(device.lastPool=data.pool,device.lastShare=moment().unix(),pool.lastShare=moment().unix()):(console.log("Detected new device/pool"),updateMiningSummary(),updateChart())}}),sixtySeconds=6e4,oncePerMinute=$timeout(miningTimeout=function(){updateMiningSummary(),updateChart(),updatePrice(),oncePerMinute=$timeout(miningTimeout,sixtySeconds)},sixtySeconds),tenSeconds=1e4,oncePerTenSeconds=$timeout(walletTimeout=function(){updateWallet(),oncePerTenSeconds=$timeout(walletTimeout,tenSeconds)},tenSeconds),$scope.$on("$destroy",function(){return socket.removeAllListeners(),oncePerTenSeconds&&$timeout.cancel(oncePerTenSeconds),oncePerMinute?$timeout.cancel(oncePerMinute):void 0})}),bitcoinApp.controller("LoginCtrl",function($scope,$location,authentication){return $scope.login=function(){return authentication.login($scope.username,$scope.password,$scope.rememberMe,function(){return $location.path("/")},function(error){return console.log(error),$scope.error=error||"Unknown error.  Try again later."})}}),bitcoinApp.controller("LogoutCtrl",function($location){return $location.path("/")}),bitcoinApp.controller("MessageBoxCtrl",function($scope,dialog,model){return $scope.title=model.title,$scope.message=model.message,$scope.buttons=model.buttons,$scope.close=function(result){return dialog.close(result)}}),bitcoinApp.controller("NavbarCtrl",function($scope,$route,$location,$rootScope,authentication){return $scope.navCollapsed=!0,$scope.authenticated=authentication.isAuthenticated(),$scope.$on("authenticationChanged",function(){return $scope.authenticated=authentication.isAuthenticated()}),$scope.logout=function(){authentication.logout(function(){return $location.path("/")})},$rootScope.$on("$routeChangeSuccess",function(){$scope.navCollapsed=!0})}),bitcoinApp.controller("NewAddressCtrl",function($scope,$timeout,dialog,walletInfo){return $scope.title="New Address",$scope.state="prompt",$scope.create=function(){return $scope.state="creating",walletInfo.newAddress($scope.label).then(function(address){return $scope.address=address.address,$scope.state="created"},function(){return $scope.state="error"})},$scope.close=function(){return dialog.close()}}),bitcoinApp.controller("PoolEditCtrl",function($scope,$location,$routeParams,pools){$scope.pool=pools.get($routeParams.poolId),$scope.save=function(pool){return pool.$save().then(function(){return $location.path("/pools")})}}),bitcoinApp.controller("PoolsCtrl",function($scope,$location,pools){$scope.pools=pools.getAll(),$scope.toggleEnabled=function(pool){return pool.enabled=!pool.enabled,pools.save(pool)},$scope.deletePool=function(pool){var index;return pools["delete"](pool.id),index=_.indexOf($scope.pools,pool),index>=0?$scope.pools.splice(index,1):void 0},$scope.editPool=function(pool){return $location.path("/pools/"+pool.id)}}),bitcoinApp.controller("SendCtrl",function($scope,popups,$location,$timeout,walletInfo){return $scope.tx={},$scope.status={},$scope.wallet=walletInfo.getSummary(1),$scope.recentRecipients=walletInfo.getRecentRecipients(),$scope.sending=!1,$scope.formatAddress=function(item){return null!=item?item.address:void 0},$scope.selectedAddress=function(item){return $scope.tx.name=item.name,$timeout(function(){return $("input[name=amount]").focus()})},$scope.positive=function(amount){return""===$.trim(amount)||amount>=1e-8},$scope.underBalance=function(amount){return null!=$scope.wallet.balance&&amount>=1e-8?amount<=$scope.wallet.balance:!0},$scope.send=function(tx){var message,recipient;return recipient=null!=tx.name?"<b>"+tx.name+"</b> ("+tx.address+")":"<b>"+tx.address+"</b>",message="Send <b>"+tx.amount+"</b> BTC to "+recipient+"?",popups.messageBox("Please confirm",message,[{result:!0,label:"Yes, Send It",cssClass:"btn-success btn-small"},{result:!1,label:"No, I Changed My Mind",cssClass:"btn-danger btn-small"}]).open().then(function(result){return result?($scope.sending=!0,$scope.error="",walletInfo.sendTx(tx).then(function(){return $location.path("/wallet")},function(error){return $scope.sending=!1,$scope.error=error})):void 0})}}),bitcoinApp.controller("ShowAddressCtrl",function($scope,dialog,model){return $scope.title="Bitcoin Address",$scope.state="created",$scope.address=model.address,$scope.label=model.label,$scope.close=function(){return dialog.close()}}),bitcoinApp.controller("SignCtrl",function($scope,popups,$location,$timeout,walletInfo){return $scope.msg={},$scope.status={},$scope.addresses=walletInfo.getAddresses(),$scope.signing=!1,$scope.signed=!1,$scope.selectedAddress=function(){return $timeout(function(){return $("textarea[name=message]").focus()})},$scope.$watchCollection("[msg.address, msg.message, msg.passphrase]",function(){return $scope.signed=!1}),$scope.sign=function(msg){return $scope.signed=!1,$scope.signing=!0,$scope.error="",walletInfo.signMsg(msg).then(function(signature){return $scope.signature=signature,$scope.signed=!0,$scope.signing=!1},function(error){return $scope.signing=!1,$scope.error=error})}}),bitcoinApp.controller("WalletCtrl",function($scope,walletInfo,popups){return $scope.count=50,$scope.wallet=walletInfo.getSummary($scope.count),$scope.filterTerm="",$scope.newAddress=function(){return popups.newAddress().open()},$scope.show=function(count){return $(document.body).addClass("wait"),$scope.wallet.$get({show:count}).then(function(){return $scope.count=count,$(document.body).removeClass("wait")})},$scope.clearFilterTerm=function(){return $scope.filterTerm=""},$scope.filterTermKeyDown=function(event){return 27===event.keyCode?$scope.clearFilterTerm():void 0}}),bitcoinApp.directive("commitOnChange",function($timeout){return{require:"ngModel",link:function($scope,$element,$attrs,modelCtrl){var $setViewValue,bufferViewValue,bufferedValue,flushViewValue,onChange;return bufferedValue=void 0,onChange=function(){return $timeout(flushViewValue)},bufferViewValue=function(value){return bufferedValue=value},flushViewValue=function(){return $setViewValue.call(modelCtrl,bufferedValue)},$setViewValue=modelCtrl.$setViewValue,modelCtrl.$setViewValue=bufferViewValue,$element.bind("change",onChange)}}}),bitcoinApp.directive("reload",function($route,$location,$rootScope){return{restrict:"A",link:function(scope,element,attrs){element.on("click",function(){"#"+$location.path()===attrs.href&&($route.reload(),$rootScope.$$phase||$rootScope.$apply())})}}}),bitcoinApp.directive("transactionList",function(){return{restrict:"E",replace:!0,templateUrl:"/templates/directives/transactionList.html",scope:{transactions:"=",filter:"="}}}),getFieldValidationExpression=function(formName,fieldName,attrs){var dirtyExpression,fieldExpression,invalidExpression,key,watchExpression;if(null==attrs&&(attrs=null),fieldExpression=formName+"."+fieldName,invalidExpression=""+fieldExpression+".$invalid",dirtyExpression=""+fieldExpression+".$dirty",watchExpression="["+invalidExpression+","+dirtyExpression,null!=attrs)for(key in attrs)attrs.hasOwnProperty(key)&&"for"!==key&&"class"!==key&&"$"!==key.substr(0,1)&&(watchExpression+=","+fieldExpression+".$error."+key);return watchExpression+="]"},bitcoinApp.filter("validationFieldFlattener",function(){return function(field){return JSON.stringify([field.$invalid,field.$dirty,field.$error])}}),bitcoinApp.directive("controlGroup",function(){return{restrict:"E",require:"^form",replace:!0,transclude:!0,template:'<div class="control-group" ng-transclude></div>',link:function($scope,el,attrs,ctrl){var fieldName,formName,watchExpression;return formName=ctrl.$name,fieldName=attrs["for"],watchExpression=getFieldValidationExpression(formName,fieldName),$scope.$watchCollection(watchExpression,function(){var error,errors,field,hasError;if(field=$scope[formName][fieldName],!field.$pristine){hasError=!1,errors=field.$error;for(error in errors)if(errors.hasOwnProperty(error)&&errors[error]){hasError=!0;break}return hasError?el.addClass("error"):el.removeClass("error")}})}}}),bitcoinApp.directive("validationMessage",function(){return{restrict:"E",require:"^form",replace:!0,template:'<div class="help-block"></div>',link:function($scope,el,attrs,ctrl){var fieldName,formName,watchExpression;return formName=ctrl.$name,fieldName=attrs["for"],watchExpression=getFieldValidationExpression(formName,fieldName,attrs),$scope.$watchCollection(watchExpression,function(){var error,errors,field,html,show;if(field=$scope[formName][fieldName],show=field.$invalid&&field.$dirty,el.css("display",show?"":"none"),html="",show){errors=field.$error;for(error in errors)errors.hasOwnProperty(error)&&errors[error]&&attrs[error]&&(html+="<span>"+attrs[error]+" </span>")}return el.html(html)})}}}),bitcoinApp.directive("submitButton",function(){return{restrict:"E",require:"^form",transclude:!0,replace:!0,template:'<button type="submit" class="btn btn-success" ng-transclude></button>',link:function($scope,el,attrs,ctrl){var watchExpression;return watchExpression=ctrl.$name+".$invalid",$scope.$watch(watchExpression,function(value){return attrs.$set("disabled",!!value)})}}}),bitcoinApp.directive("validSubmit",function(){return{restrict:"A",require:"form",link:function($scope,el,attrs,ctrl){var $element;return $element=angular.element(el),attrs.$set("novalidate","novalidate"),$element.bind("submit",function(e){var form;return e.preventDefault(),$element.find(".ng-pristine").removeClass("ng-pristine"),form=$scope[ctrl.$name],angular.forEach(form,function(formElement,fieldName){"$"!==fieldName[0]&&(formElement.$pristine=!1,formElement.$dirty=!0)}),form.$invalid?($element.find(".ng-invalid").first().focus(),$scope.$apply(),!1):($scope.$eval(attrs.validSubmit),$scope.$apply())})}}}),hashrateFilter=null,bitcoinApp.filter("archived",function(){return function(array,archived){return null==archived&&(archived=!0),_.filter(array,function(item){var _ref;return(null!=(_ref=item.archived)?_ref:!1)===archived})}}),bitcoinApp.filter("safeId",function(){return function(input){return CryptoJS.MD5(input).toString()}}),bitcoinApp.filter("hashrate",function(){return hashrateFilter=function(input){var hashrate,units;return hashrate=Number(input),isNaN(hashrate)||0>=hashrate?"-":(units="MH",hashrate>=1e3&&(hashrate/=1e3,units="GH"),hashrate>=1e3&&(hashrate/=1e3,units="TH"),hashrate>=1e3&&(hashrate/=1e3,units="PH"),hashrate=hashrate.toPrecision(3),""+hashrate+" "+units+"/s")}}),bitcoinApp.filter("confirmationCount",function(numberFilter){return function(transaction){return transaction.confirmed?"✓":numberFilter(transaction.confirmations,"0")}}),bitcoinApp.filter("transactionDescription",function(){return function(tx){var msg;switch(msg="",tx.category){case"receive":msg=null!=tx.account?tx.account:tx.address;break;case"send":msg="to: ",msg+=null!=tx.to?tx.to:tx.address,null!=tx.comment&&(msg+=" ("+tx.comment+")"),tx.fee<0&&(msg+=", fee: "+-1*tx.fee);break;case"generate":case"immature":null!=tx.account&&(msg+=""+tx.account+", "),msg+="generated";break;default:msg="unknown"}return msg}}),bitcoinApp.filter("bitcoin",function(numberFilter){return function(amount){var formatted,i,length;if(formatted=numberFilter(amount,8),""!==formatted){for(i=0,length=formatted.length;6>i&&"0"===formatted.substr(length-i-1,1);)i++;formatted=formatted.substr(0,length-i)}return formatted}}),bitcoinApp.filter("timeSince",function(){return function(timestamp){var now;return now=moment.unix(),timestamp>now?"just now":moment.unix(timestamp).fromNow().replace("a few seconds ago","just now")}}),bitcoinApp.filter("suffix",function(){return function(value,suffix,includeZero){return null==includeZero&&(includeZero=!0),null==value||""===value||0===value&&!includeZero?"":value+suffix}}),bitcoinApp.filter("prefix",function(){return function(value,prefix,includeZero){return null==includeZero&&(includeZero=!0),null==value||""===value||0===value&&!includeZero?"":prefix+value}}),bitcoinApp.filter("rejectPercent",function(){return function(counts){var rejected;return rejected=0,0!==counts.shares&&(rejected=(100*counts.rejected/counts.shares).toFixed(1)),""+rejected+"%"}}),bitcoinApp.filter("prettyJson",function(){return function(obj){return JSON.stringify(obj,null,2)}}),bitcoinApp.factory("authentication",function($http,$rootScope,$cookieStore){var authenticated,changeAuthenticated;return authenticated=$cookieStore.get("authenticated")||!1,changeAuthenticated=function(newValue){return authenticated===!newValue?(authenticated=newValue,$rootScope.$broadcast("authenticationChanged")):void 0},{isAuthenticated:function(){return authenticated},login:function(username,password,rememberMe,success,error){return $http.post("/login",{username:username,password:password,rememberMe:rememberMe}).success(function(response){response.success?(changeAuthenticated(!0),"function"==typeof success&&success()):error(response.error)}).error(function(){"function"==typeof error&&error()})},logout:function(success,error){return $http.post("/logout").success(function(){return changeAuthenticated(!1),"function"==typeof success?success():void 0}).error(error)}}}),bitcoinApp.factory("miningStats",function($http,$q,$resource){var chart,summary;return summary=$resource("/mining/summary"),chart=$resource("/mining/chart"),{getSummary:function(){return summary.get()},getChart:function(){return chart.get()}}}),bitcoinApp.factory("pools",function($resource){var resource;return resource=$resource("/pools/:id",{id:"@id"},{"delete":{method:"DELETE",params:{id:"@id"}}}),{getAll:function(){return resource.query()},get:function(id){return resource.get({id:id})},save:function(pool){return pool.$save()},"delete":function(id){return resource["delete"]({id:id})}}}),bitcoinApp.factory("popups",function($dialog){return{messageBox:function(title,message,buttons){return $dialog.dialog({templateUrl:"/templates/messageBox.html",controller:"MessageBoxCtrl",resolve:{model:function(){return{title:title,message:message,buttons:buttons}}}})},changeLabel:function(address,label){return $dialog.dialog({templateUrl:"/templates/changeLabel.html",controller:"ChangeLabelCtrl",resolve:{model:function(){return{address:address,label:label}}}})},newAddress:function(){return $dialog.dialog({templateUrl:"/templates/newAddress.html",controller:"NewAddressCtrl"})},showAddress:function(address,label){return $dialog.dialog({templateUrl:"/templates/newAddress.html",controller:"ShowAddressCtrl",resolve:{model:function(){return{address:address,label:label}}}})}}}),bitcoinApp.factory("socket",function($rootScope){var socket;return socket=io.connect(),{on:function(eventName,callback){return socket.on(eventName,function(){var args;return args=arguments,$rootScope.$apply(function(){return callback.apply(socket,args)})})},emit:function(eventName,data,callback){return socket.emit(eventName,data,function(){var args;return args=arguments,$rootScope.$apply(function(){return callback?callback.apply(socket,args):void 0})})},removeAllListeners:function(){return socket.removeAllListeners()}}}),bitcoinApp.factory("walletInfo",function($resource,$http,$q){var addresses,price,recipients,summary;return summary=$resource("/wallet/summary"),price=$resource("/wallet/price"),recipients=$resource("/wallet/recentRecipients",{},{get:{method:"GET",isArray:!0}}),addresses=$resource("/wallet/addresses"),{getSummary:function(num){return summary.get({show:num})},getPrice:function(){return price.get()},getRecentRecipients:function(){return recipients.get()},getAddresses:function(){return addresses.query()},newAddress:function(label){var deferred;return deferred=$q.defer(),$http.post("/wallet/newaddress",{label:label}).success(function(address){return deferred.resolve(address)}).error(function(){return deferred.reject()}),deferred.promise},sendTx:function(tx){var deferred;return deferred=$q.defer(),$http({method:"POST",url:"/wallet/send",data:tx}).success(function(){return deferred.resolve()}).error(function(data){return deferred.reject(data.error)}),deferred.promise},signMsg:function(msg){var deferred;return deferred=$q.defer(),$http({method:"POST",url:"/wallet/sign",data:msg}).success(function(data){return deferred.resolve(data.signature)}).error(function(data){return deferred.reject(data.error)}),deferred.promise}}})}).call(this);